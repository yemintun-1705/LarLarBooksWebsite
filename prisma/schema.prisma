// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Profiles (Users) - Platform users with authentication
model Profile {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email      String?   @unique
  password   String?   // Hashed password
  username   String?   @unique
  fullName   String?   @map("full_name")
  avatarUrl  String?   @map("avatar_url")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  reviews        Review[]
  comments       Comment[]
  readingProgress ReadingProgress[]
  userLibrary    UserLibrary[]

  @@map("profiles")
}

// Users
model User {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                  String
  userId                String?   @map("user_id") @db.Uuid
  profileImageUrl       String?   @map("profile_image_url")
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  books Book[]

  @@map("users")
}

// Authors
model Author {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  contactEmail String?   @map("contact_email")
  website      String?
  userId       String?   @map("user_id") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  books Book[] @relation("BookAuthor")

  @@map("authors")
}

// Genres
model Genre {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  genreName String   @map("genre_name")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  bookGenres BookGenre[]

  @@map("genres")
}

// Books
model Book {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookName        String    @map("book_name")
  bookCoverPath   String?   @map("book_cover_path")
  authorId        String?   @map("author_id") @db.Uuid
  publisherId     String?   @map("publisher_id") @db.Uuid
  status          String?
  description     String?
  isbn            String?
  pageCount       Int?      @map("page_count")
  language        String?   @default("en")
  price           Decimal?  @db.Decimal
  publicationDate DateTime? @map("publication_date") @db.Date
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  user            User?             @relation(fields: [authorId], references: [id])
  author          Author?           @relation("BookAuthor", fields: [publisherId], references: [id])
  bookGenres      BookGenre[]
  bookContent     BookContent[]
  reviews         Review[]
  comments        Comment[]
  readingProgress ReadingProgress[]
  userLibrary     UserLibrary[]

  @@map("books")
}

// Book Genres (Junction Table)
model BookGenre {
  id      BigInt  @id @default(autoincrement())
  bookId  String? @map("book_id") @db.Uuid
  genreId String? @map("genre_id") @db.Uuid

  // Relations
  book  Book?  @relation(fields: [bookId], references: [id])
  genre Genre? @relation(fields: [genreId], references: [id])

  @@map("book_genres")
}

// Book Content
model BookContent {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookId      String? @map("book_id") @db.Uuid
  contentType String  @map("content_type")
  pdfPath     String? @map("pdf_path")
  jsonContent Json?   @map("json_content")

  // Relations
  book Book? @relation(fields: [bookId], references: [id])

  @@map("book_content")
}

// Reviews
model Review {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookId     String?   @map("book_id") @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  rating     Int?      @db.SmallInt
  reviewText String?   @map("review_text")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  book Book?    @relation(fields: [bookId], references: [id])
  user Profile? @relation(fields: [userId], references: [id])

  @@map("reviews")
}

// Comments
model Comment {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bookId      String?   @map("book_id") @db.Uuid
  userId      String?   @map("user_id") @db.Uuid
  commentText String    @map("comment_text")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  book Book?    @relation(fields: [bookId], references: [id])
  user Profile? @relation(fields: [userId], references: [id])

  @@map("comments")
}

// Reading Progress
model ReadingProgress {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  bookId      String    @map("book_id") @db.Uuid
  currentPage Int?      @default(0) @map("current_page")
  lastReadAt  DateTime? @default(now()) @map("last_read_at") @db.Timestamptz(6)
  bookmarks   Json?     @default("[]")

  // Relations
  user Profile @relation(fields: [userId], references: [id])
  book Book    @relation(fields: [bookId], references: [id])

  @@map("reading_progress")
}

// User Library
model UserLibrary {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  bookId        String    @map("book_id") @db.Uuid
  purchasedAt   DateTime? @default(now()) @map("purchased_at") @db.Timestamptz(6)
  purchasePrice Decimal?  @map("purchase_price") @db.Decimal

  // Relations
  user Profile @relation(fields: [userId], references: [id])
  book Book    @relation(fields: [bookId], references: [id])

  @@map("user_library")
}
